name: Smoke Test - Staging

on:
  pull_request:
    branches:
      - staging
  push:
    branches:
      - staging
  workflow_dispatch:
    inputs:
      smoke_base:
        description: 'Base URL to test (overrides secret)'
        required: false
        type: string
      smoke_origin:
        description: 'Origin for CORS (overrides secret)'
        required: false
        type: string
      campaign_id:
        description: 'Mautic campaign ID (overrides secret)'
        required: false
        type: string

jobs:
  smoke-test-staging:
    name: Run Smoke Tests on Staging
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run smoke tests
        id: smoke
        env:
          SMOKE_BASE: ${{ inputs.smoke_base || secrets.SMOKE_BASE_STAGING }}
          SMOKE_ORIGIN: ${{ inputs.smoke_origin || secrets.SMOKE_ORIGIN_STAGING }}
          MAUTIC_CAMPAIGN_INVESTOR_WELCOME: ${{ inputs.campaign_id || secrets.MAUTIC_CAMPAIGN_INVESTOR_WELCOME_STAGING }}
        run: |
          echo "Running smoke tests against staging..."
          node scripts/smoke-run.mjs || echo "SMOKE_FAILED=true" >> $GITHUB_ENV
          
      - name: Upload smoke test log
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: smoke-log-staging
          path: smoke.log
          retention-days: 30

      - name: Post PR comment with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const logPath = 'smoke.log';
            
            let logContent = 'Log file not found';
            let logTail = 'No log content available';
            
            if (fs.existsSync(logPath)) {
              logContent = fs.readFileSync(logPath, 'utf8');
              const lines = logContent.split('\n');
              const tailLines = lines.slice(-30); // Last 30 lines
              logTail = tailLines.join('\n');
            }
            
            const passed = !process.env.SMOKE_FAILED;
            const status = passed ? '‚úÖ PASS' : '‚ùå FAIL';
            const emoji = passed ? 'üéâ' : '‚ö†Ô∏è';
            
            const body = `## ${emoji} Staging Smoke Test Results
            
            **Status:** ${status}
            
            ### Log Tail (last 30 lines)
            \`\`\`
            ${logTail}
            \`\`\`
            
            <details>
            <summary>View full smoke test log</summary>
            
            Download the \`smoke-log-staging\` artifact from the workflow run for complete logs.
            
            </details>
            
            ---
            **Workflow Run:** [#${context.runNumber}](${context.payload.repository.html_url}/actions/runs/${context.runId})
            `;
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Staging Smoke Test Results')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Write job summary
        if: always()
        run: |
          echo "## Smoke Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$SMOKE_FAILED" = "true" ]; then
            echo "‚ùå **Status:** FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Some smoke tests did not pass. Please review the logs for details." >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ **Status:** PASSED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All required smoke tests passed successfully!" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Base URL:** \`$SMOKE_BASE\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Origin:** \`$SMOKE_ORIGIN\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Campaign ID:** \`${MAUTIC_CAMPAIGN_INVESTOR_WELCOME:-not set}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View the uploaded \`smoke-log-staging\` artifact for complete test output." >> $GITHUB_STEP_SUMMARY

      - name: Fail workflow if smoke tests failed
        if: env.SMOKE_FAILED == 'true'
        run: exit 1
