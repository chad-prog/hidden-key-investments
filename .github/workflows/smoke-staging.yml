name: Smoke Test - Staging

on:
  pull_request:
    branches:
      - staging
  push:
    branches:
      - staging
  workflow_dispatch:
    inputs:
      smoke_base:
        description: 'Base URL for smoke test'
        required: false
        default: ''
      smoke_origin:
        description: 'Origin for CORS validation'
        required: false
        default: ''
      campaign_id:
        description: 'Mautic campaign ID'
        required: false
        default: ''

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    name: Run Smoke Tests
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run smoke tests
        id: smoke
        env:
          SMOKE_BASE: ${{ inputs.smoke_base || secrets.SMOKE_BASE_STAGING }}
          SMOKE_ORIGIN: ${{ inputs.smoke_origin || secrets.SMOKE_ORIGIN_STAGING }}
          MAUTIC_CAMPAIGN_INVESTOR_WELCOME: ${{ inputs.campaign_id || secrets.MAUTIC_CAMPAIGN_INVESTOR_WELCOME_STAGING }}
        run: |
          echo "Running smoke tests against: $SMOKE_BASE"
          node scripts/smoke-run.mjs
        continue-on-error: true
      
      - name: Upload smoke test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-logs-staging
          path: smoke.log
          retention-days: 30
      
      - name: Read smoke test log
        if: always()
        id: read-log
        run: |
          if [ -f smoke.log ]; then
            # Get last 50 lines of log
            echo "LOG_TAIL<<EOF" >> $GITHUB_OUTPUT
            tail -n 50 smoke.log >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "LOG_TAIL=No log file found" >> $GITHUB_OUTPUT
          fi
      
      - name: Write job summary
        if: always()
        run: |
          echo "## Smoke Test Results - Staging" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${{ steps.smoke.outcome == 'success' && '‚úÖ PASS' || '‚ùå FAIL' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: Staging" >> $GITHUB_STEP_SUMMARY
          echo "**Base URL**: \`${{ secrets.SMOKE_BASE_STAGING }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Log Tail (last 50 lines)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.read-log.outputs.LOG_TAIL }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
      
      - name: Post or update PR comment
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          LOG_TAIL: ${{ steps.read-log.outputs.LOG_TAIL }}
        with:
          script: |
            const outcome = '${{ steps.smoke.outcome }}';
            const logTail = process.env.LOG_TAIL;
            
            const body = `## üß™ Smoke Test Results - Staging
            
            **Status**: ${outcome === 'success' ? '‚úÖ PASS' : '‚ùå FAIL'}
            **Environment**: Staging
            **Timestamp**: ${new Date().toISOString()}
            
            ### Log Tail (last 50 lines)
            \`\`\`
            ${logTail}
            \`\`\`
            
            <details>
            <summary>View full logs</summary>
            
            Download the \`smoke-test-logs-staging\` artifact from the workflow run to see the complete log.
            </details>
            `;
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('üß™ Smoke Test Results - Staging')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
      
      - name: Fail job if smoke tests failed
        if: steps.smoke.outcome != 'success'
        run: |
          echo "‚ùå Smoke tests failed"
          exit 1
