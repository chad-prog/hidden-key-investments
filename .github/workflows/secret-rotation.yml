name: Secret Rotation Reminder

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read
  issues: write

jobs:
  check-secret-rotation:
    name: Check Secret Rotation Status
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Check secret rotation log
        id: check
        run: |
          echo "Checking secret rotation status..."
          
          # Check if rotation log exists
          if [ ! -f "docs/SECRET-ROTATION-LOG.md" ]; then
            echo "warning=Secret rotation log not found" >> $GITHUB_OUTPUT
            echo "needs_attention=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Parse log file and check for secrets needing rotation
          # This is a simplified check - in production, you'd parse the actual dates
          
          ROTATION_DAYS=90
          TODAY=$(date +%s)
          NEEDS_ROTATION=false
          
          echo "Secret rotation check completed"
          echo "needs_attention=false" >> $GITHUB_OUTPUT
      
      - name: Create reminder issue
        if: steps.check.outputs.needs_attention == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ðŸ” Secret Rotation Reminder';
            const body = `
            ## Secret Rotation Reminder
            
            This is a scheduled reminder to review and rotate secrets according to the rotation policy.
            
            ### Actions Required
            
            1. Review \`docs/SECRET-ROTATION-LOG.md\` for secrets needing rotation
            2. Rotate secrets that are older than 90 days:
               - Supabase keys
               - Mailchimp API key
               - Airtable API key
               - GitHub tokens
            3. Update the rotation log after each rotation
            4. Test in staging before deploying to production
            
            ### How to Rotate Secrets
            
            Run the rotation helper script:
            \`\`\`bash
            bash scripts/rotate-secrets.sh
            \`\`\`
            
            For detailed procedures, see:
            - \`docs/SECRET-ROTATION-POLICY.md\`
            - \`docs/SECRET-ROTATION-LOG.md\`
            
            ### Checklist
            
            - [ ] Reviewed rotation log
            - [ ] Rotated Supabase keys (if needed)
            - [ ] Rotated Mailchimp API key (if needed)
            - [ ] Rotated Airtable API key (if needed)
            - [ ] Rotated GitHub tokens (if needed)
            - [ ] Updated rotation log
            - [ ] Tested in staging
            - [ ] Deployed to production
            - [ ] Verified functionality
            - [ ] Revoked old secrets
            
            **Auto-generated by**: Secret Rotation Reminder workflow
            **Schedule**: Weekly on Mondays at 9 AM UTC
            `;
            
            // Check if an issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['security', 'secret-rotation']
            });
            
            if (issues.data.length === 0) {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['security', 'secret-rotation', 'automated']
              });
              console.log('Created new secret rotation reminder issue');
            } else {
              console.log('Secret rotation issue already exists');
            }
      
      - name: Post summary
        run: |
          echo "## Secret Rotation Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Secret rotation status checked" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Next scheduled check: Next Monday at 9 AM UTC" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To manually check secret rotation status:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "bash scripts/rotate-secrets.sh" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
