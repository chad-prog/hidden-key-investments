name: Rollback - Staging Deploy

on:
  workflow_dispatch:
    inputs:
      deploy_id:
        description: 'Deploy ID to restore (leave empty for previous ready deploy)'
        required: false
        type: string
      slack_tone:
        description: 'Slack notification tone'
        required: false
        default: 'heroic-ceremony'
        type: choice
        options:
          - heroic-ceremony
          - calm-informative
          - urgent-alert
          - celebration

permissions:
  contents: read

jobs:
  rollback-staging:
    name: Rollback Staging Deployment
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate inputs
        id: validate
        run: |
          if [ -z "${{ secrets.NETLIFY_AUTH_TOKEN }}" ]; then
            echo "‚ùå NETLIFY_AUTH_TOKEN secret is not configured"
            exit 1
          fi
          
          if [ -z "${{ secrets.NETLIFY_SITE_ID_STAGING }}" ]; then
            echo "‚ùå NETLIFY_SITE_ID_STAGING secret is not configured"
            exit 1
          fi
          
          echo "‚úÖ Required secrets are configured"
      
      - name: Get target deploy
        id: get-deploy
        run: |
          if [ -n "${{ github.event.inputs.deploy_id }}" ]; then
            # Use provided deploy ID
            DEPLOY_ID="${{ github.event.inputs.deploy_id }}"
            echo "Using provided deploy ID: $DEPLOY_ID"
          else
            # Fetch previous ready deploy
            echo "Fetching previous ready deploy..."
            
            DEPLOYS=$(curl -s -H "Authorization: Bearer ${{ secrets.NETLIFY_AUTH_TOKEN }}" \
              "https://api.netlify.com/api/v1/sites/${{ secrets.NETLIFY_SITE_ID_STAGING }}/deploys?per_page=10")
            
            # Find the most recent "ready" deploy that's not the current one
            DEPLOY_ID=$(echo "$DEPLOYS" | jq -r '
              .[] | 
              select(.state == "ready") | 
              select(.commit_ref == "refs/heads/staging") |
              .id' | head -n 2 | tail -n 1)
          fi
          
          if [ -z "$DEPLOY_ID" ] || [ "$DEPLOY_ID" = "null" ]; then
            echo "‚ùå No suitable deploy found for rollback"
            exit 1
          fi
          
          echo "deploy_id=$DEPLOY_ID" >> $GITHUB_OUTPUT
          
          # Get deploy details
          DEPLOY_INFO=$(curl -s -H "Authorization: Bearer ${{ secrets.NETLIFY_AUTH_TOKEN }}" \
            "https://api.netlify.com/api/v1/deploys/$DEPLOY_ID")
          
          DEPLOY_URL=$(echo "$DEPLOY_INFO" | jq -r '.url')
          DEPLOY_CREATED=$(echo "$DEPLOY_INFO" | jq -r '.created_at')
          DEPLOY_COMMIT=$(echo "$DEPLOY_INFO" | jq -r '.commit_ref')
          
          echo "deploy_url=$DEPLOY_URL" >> $GITHUB_OUTPUT
          echo "deploy_created=$DEPLOY_CREATED" >> $GITHUB_OUTPUT
          echo "deploy_commit=$DEPLOY_COMMIT" >> $GITHUB_OUTPUT
          
          echo "Target deploy:"
          echo "  ID: $DEPLOY_ID"
          echo "  URL: $DEPLOY_URL"
          echo "  Created: $DEPLOY_CREATED"
          echo "  Commit: $DEPLOY_COMMIT"
      
      - name: Confirm rollback
        run: |
          echo "‚ö†Ô∏è Rolling back staging to deploy: ${{ steps.get-deploy.outputs.deploy_id }}"
          echo "   Created: ${{ steps.get-deploy.outputs.deploy_created }}"
          echo "   Commit: ${{ steps.get-deploy.outputs.deploy_commit }}"
      
      - name: Restore deploy
        id: restore
        run: |
          echo "Restoring deploy: ${{ steps.get-deploy.outputs.deploy_id }}"
          
          RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.NETLIFY_AUTH_TOKEN }}" \
            "https://api.netlify.com/api/v1/sites/${{ secrets.NETLIFY_SITE_ID_STAGING }}/deploys/${{ steps.get-deploy.outputs.deploy_id }}/restore")
          
          echo "$RESPONSE" | jq .
          
          # Check if restore was successful
          if echo "$RESPONSE" | jq -e '.state' > /dev/null; then
            RESTORE_STATE=$(echo "$RESPONSE" | jq -r '.state')
            echo "‚úÖ Restore initiated successfully (state: $RESTORE_STATE)"
            echo "success=true" >> $GITHUB_OUTPUT
            echo "state=$RESTORE_STATE" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Restore failed"
            echo "$RESPONSE"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: Wait for deploy to be ready
        id: wait
        run: |
          echo "Waiting for deploy to be ready..."
          
          MAX_ATTEMPTS=30
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            DEPLOY_INFO=$(curl -s -H "Authorization: Bearer ${{ secrets.NETLIFY_AUTH_TOKEN }}" \
              "https://api.netlify.com/api/v1/deploys/${{ steps.get-deploy.outputs.deploy_id }}")
            
            STATE=$(echo "$DEPLOY_INFO" | jq -r '.state')
            
            echo "Attempt $((ATTEMPT + 1))/$MAX_ATTEMPTS - State: $STATE"
            
            if [ "$STATE" = "ready" ]; then
              echo "‚úÖ Deploy is ready"
              echo "ready=true" >> $GITHUB_OUTPUT
              exit 0
            elif [ "$STATE" = "error" ]; then
              echo "‚ùå Deploy failed"
              echo "ready=false" >> $GITHUB_OUTPUT
              exit 1
            fi
            
            ATTEMPT=$((ATTEMPT + 1))
            sleep 10
          done
          
          echo "‚ö†Ô∏è Deploy did not reach ready state within timeout"
          echo "ready=false" >> $GITHUB_OUTPUT
          exit 1
      
      - name: Create summary
        if: always()
        run: |
          echo "# üîÑ Staging Rollback" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.restore.outputs.success }}" = "true" ]; then
            echo "## ‚úÖ Status: SUCCESS" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ‚ùå Status: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Restore deploy ID:** \`${{ steps.get-deploy.outputs.deploy_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Deploy created:** ${{ steps.get-deploy.outputs.deploy_created }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deploy commit:** \`${{ steps.get-deploy.outputs.deploy_commit }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Deploy URL:** ${{ steps.get-deploy.outputs.deploy_url }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.wait.outputs.ready }}" = "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚úÖ Deploy is now live and serving traffic" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Notify Slack
        if: always() && secrets.SLACK_WEBHOOK_ALL_HANDS != ''
        run: |
          # Determine message based on tone
          case "${{ github.event.inputs.slack_tone }}" in
            "heroic-ceremony")
              TITLE="ü¶∏ Heroic Rollback Ceremony - Staging"
              COLOR="#FFD700"
              MESSAGE="A noble rollback has been performed by the valiant @${{ github.actor }}! The staging realm has been restored to a previous state of glory."
              ;;
            "calm-informative")
              TITLE="üîÑ Staging Rollback Completed"
              COLOR="#36A64F"
              MESSAGE="Staging environment has been rolled back to a previous deploy by @${{ github.actor }}."
              ;;
            "urgent-alert")
              TITLE="üö® Urgent: Staging Rollback"
              COLOR="#FF0000"
              MESSAGE="Emergency rollback performed on staging by @${{ github.actor }}. Immediate attention may be required."
              ;;
            "celebration")
              TITLE="üéâ Staging Rollback Success"
              COLOR="#00FF00"
              MESSAGE="Woo-hoo! @${{ github.actor }} successfully rolled back staging. Everything is back to normal!"
              ;;
            *)
              TITLE="üîÑ Staging Rollback"
              COLOR="#36A64F"
              MESSAGE="Staging rollback performed by @${{ github.actor }}."
              ;;
          esac
          
          SUCCESS_ICON="‚úÖ"
          if [ "${{ steps.restore.outputs.success }}" != "true" ]; then
            SUCCESS_ICON="‚ùå"
            COLOR="#FF0000"
          fi
          
          curl -X POST ${{ secrets.SLACK_WEBHOOK_ALL_HANDS }} \
            -H 'Content-Type: application/json' \
            -d "{
              \"text\": \"${TITLE}\",
              \"attachments\": [
                {
                  \"color\": \"${COLOR}\",
                  \"blocks\": [
                    {
                      \"type\": \"header\",
                      \"text\": {
                        \"type\": \"plain_text\",
                        \"text\": \"${TITLE}\"
                      }
                    },
                    {
                      \"type\": \"section\",
                      \"text\": {
                        \"type\": \"mrkdwn\",
                        \"text\": \"${MESSAGE}\"
                      }
                    },
                    {
                      \"type\": \"section\",
                      \"fields\": [
                        {
                          \"type\": \"mrkdwn\",
                          \"text\": \"*Status:*\\n${SUCCESS_ICON} ${{ steps.restore.outputs.success == 'true' && 'Success' || 'Failed' }}\"
                        },
                        {
                          \"type\": \"mrkdwn\",
                          \"text\": \"*Triggered by:*\\n@${{ github.actor }}\"
                        },
                        {
                          \"type\": \"mrkdwn\",
                          \"text\": \"*Deploy ID:*\\n\`${{ steps.get-deploy.outputs.deploy_id }}\`\"
                        },
                        {
                          \"type\": \"mrkdwn\",
                          \"text\": \"*Site:*\\n${{ vars.NETLIFY_SITE_NAME || 'Hidden Key Investments' }}\"
                        }
                      ]
                    },
                    {
                      \"type\": \"section\",
                      \"text\": {
                        \"type\": \"mrkdwn\",
                        \"text\": \"*Deploy URL:*\\n${{ steps.get-deploy.outputs.deploy_url }}\"
                      }
                    },
                    {
                      \"type\": \"actions\",
                      \"elements\": [
                        {
                          \"type\": \"button\",
                          \"text\": {
                            \"type\": \"plain_text\",
                            \"text\": \"View Workflow\"
                          },
                          \"url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
                        },
                        {
                          \"type\": \"button\",
                          \"text\": {
                            \"type\": \"plain_text\",
                            \"text\": \"Visit Site\"
                          },
                          \"url\": \"${{ steps.get-deploy.outputs.deploy_url }}\"
                        }
                      ]
                    }
                  ]
                }
              ]
            }"
      
      - name: Fail if rollback unsuccessful
        if: steps.restore.outputs.success != 'true'
        run: |
          echo "‚ùå Rollback failed"
          exit 1
