name: Rollback - Staging

on:
  workflow_dispatch:
    inputs:
      deploy_id:
        description: 'Deploy ID to restore (leave empty for previous)'
        required: false
        default: ''

jobs:
  rollback:
    runs-on: ubuntu-latest
    name: Rollback Staging Deployment
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate inputs
        run: |
          if [ -z "${{ secrets.NETLIFY_AUTH_TOKEN }}" ]; then
            echo "âŒ NETLIFY_AUTH_TOKEN secret is not set"
            exit 1
          fi
          
          if [ -z "${{ secrets.NETLIFY_SITE_ID_STAGING }}" ]; then
            echo "âŒ NETLIFY_SITE_ID_STAGING secret is not set"
            exit 1
          fi
          
          echo "âœ… Required secrets are configured"
      
      - name: Fetch deploy to restore
        id: fetch-deploy
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID_STAGING }}
          REQUESTED_DEPLOY_ID: ${{ inputs.deploy_id }}
        run: |
          if [ -n "$REQUESTED_DEPLOY_ID" ]; then
            echo "Using provided deploy ID: $REQUESTED_DEPLOY_ID"
            DEPLOY_ID="$REQUESTED_DEPLOY_ID"
          else
            echo "Fetching previous ready deploy..."
            
            # Fetch recent deploys
            DEPLOYS=$(curl -s -H "Authorization: Bearer $NETLIFY_AUTH_TOKEN" \
              "https://api.netlify.com/api/v1/sites/$NETLIFY_SITE_ID/deploys?per_page=10")
            
            # Find the previous ready deploy (not the current one)
            DEPLOY_ID=$(echo "$DEPLOYS" | jq -r '
              [.[] | select(.state == "ready")] | 
              sort_by(.published_at) | 
              reverse | 
              .[1].id
            ')
            
            if [ -z "$DEPLOY_ID" ] || [ "$DEPLOY_ID" = "null" ]; then
              echo "âŒ Could not find previous deploy to rollback to"
              exit 1
            fi
            
            echo "Found previous deploy: $DEPLOY_ID"
          fi
          
          # Get deploy details
          DEPLOY_INFO=$(curl -s -H "Authorization: Bearer $NETLIFY_AUTH_TOKEN" \
            "https://api.netlify.com/api/v1/sites/$NETLIFY_SITE_ID/deploys/$DEPLOY_ID")
          
          DEPLOY_URL=$(echo "$DEPLOY_INFO" | jq -r '.deploy_ssl_url // .ssl_url // .url')
          DEPLOY_CREATED=$(echo "$DEPLOY_INFO" | jq -r '.created_at')
          DEPLOY_BRANCH=$(echo "$DEPLOY_INFO" | jq -r '.branch // "unknown"')
          
          echo "DEPLOY_ID=$DEPLOY_ID" >> $GITHUB_OUTPUT
          echo "DEPLOY_URL=$DEPLOY_URL" >> $GITHUB_OUTPUT
          echo "DEPLOY_CREATED=$DEPLOY_CREATED" >> $GITHUB_OUTPUT
          echo "DEPLOY_BRANCH=$DEPLOY_BRANCH" >> $GITHUB_OUTPUT
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“¦ Deploy to Restore" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deploy ID**: \`$DEPLOY_ID\`" >> $GITHUB_STEP_SUMMARY
          echo "**URL**: $DEPLOY_URL" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: $DEPLOY_BRANCH" >> $GITHUB_STEP_SUMMARY
          echo "**Created**: $DEPLOY_CREATED" >> $GITHUB_STEP_SUMMARY
      
      - name: Confirm rollback
        run: |
          echo "ðŸ”„ Preparing to rollback staging deployment"
          echo "Deploy ID: ${{ steps.fetch-deploy.outputs.DEPLOY_ID }}"
          echo "Deploy URL: ${{ steps.fetch-deploy.outputs.DEPLOY_URL }}"
          echo "Branch: ${{ steps.fetch-deploy.outputs.DEPLOY_BRANCH }}"
      
      - name: Restore deploy
        id: restore
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID_STAGING }}
          DEPLOY_ID: ${{ steps.fetch-deploy.outputs.DEPLOY_ID }}
        run: |
          echo "Restoring deploy: $DEPLOY_ID"
          
          RESTORE_RESULT=$(curl -s -X POST \
            -H "Authorization: Bearer $NETLIFY_AUTH_TOKEN" \
            "https://api.netlify.com/api/v1/sites/$NETLIFY_SITE_ID/deploys/$DEPLOY_ID/restore")
          
          echo "âœ… Rollback completed successfully"
          echo "Deploy $DEPLOY_ID has been restored"
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… Rollback Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: Success" >> $GITHUB_STEP_SUMMARY
          echo "**Restored Deploy**: \`$DEPLOY_ID\`" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
      
      - name: Announce to Slack
        if: success() && secrets.SLACK_WEBHOOK_ALL_HANDS != ''
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_ALL_HANDS }}
          DEPLOY_ID: ${{ steps.fetch-deploy.outputs.DEPLOY_ID }}
          DEPLOY_URL: ${{ steps.fetch-deploy.outputs.DEPLOY_URL }}
          DEPLOY_BRANCH: ${{ steps.fetch-deploy.outputs.DEPLOY_BRANCH }}
          ACTOR: ${{ github.actor }}
        run: |
          # Heroic ceremony Block Kit message
          SLACK_PAYLOAD=$(cat <<EOF
          {
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "ðŸ”„ Staging Rollback Executed",
                  "emoji": true
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Environment:*\nStaging"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Initiated By:*\n$ACTOR"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Deploy ID:*\n\`$DEPLOY_ID\`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Branch:*\n$DEPLOY_BRANCH"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Deploy URL:* $DEPLOY_URL"
                }
              },
              {
                "type": "divider"
              },
              {
                "type": "context",
                "elements": [
                  {
                    "type": "mrkdwn",
                    "text": "ðŸŽ‰ Previous deployment has been successfully restored. The staging environment is now running the rolled-back version."
                  }
                ]
              }
            ]
          }
          EOF
          )
          
          curl -X POST -H 'Content-type: application/json' \
            --data "$SLACK_PAYLOAD" \
            "$SLACK_WEBHOOK"
          
          echo "âœ… Slack notification sent"
